services:
  ruby:
    from: 'ruby:2.2.3'
    build:
      - 'gem install foreman'
      - '/bin/sh -lc "curl -sL https://deb.nodesource.com/setup_4.x | bash -"'
      - 'apt-get update'
      - 'apt-get install -y build-essential nodejs'

defaults: &defaults
  service: ruby
  folder: /app
  prepare:
    - 'node -v'
    - "echo 'this is prepare section'"
    - "echo '.'"

staging:
  <<: *defaults
  cmd: 'foreman start'
  ports:
   - 3001
   - 3002
  env:
    - NODE_ENV=production
    - RACK_ENV=production

tests:
  <<: *defaults
  cmd: 'for i in {1..100}; do printf "."; sleep 0.1; done; printf "\n";'
  env:
    - NODE_ENV=production
    - RACK_ENV=production
